<?xml version="1.0" encoding="UTF-8"?>

<beans:beans xmlns="http://www.springframework.org/schema/security"
             xmlns:beans="http://www.springframework.org/schema/beans"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xsi:schemaLocation="http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans-3.1.xsd
           http://www.springframework.org/schema/security
           http://www.springframework.org/schema/security/spring-security-3.1.xsd">

   <!-- Entry points -->
   <http pattern="/test.xhtml" security="none" create-session="never" use-expressions="true"/>
   <http pattern="/start.xhtml" security="none" create-session="never" use-expressions="true"/>
   <http pattern="/welcome.xhtml" security="none" create-session="never" use-expressions="true"/>
   <http pattern="/announcement.xhtml" security="none" create-session="never" use-expressions="true"/>
   <http pattern="/login.xhtml" security="none" create-session="never" use-expressions="true"/>
   <http pattern="/message.xhtml" security="none" create-session="never" use-expressions="true"/>
   <http pattern="/index.xhtml" security="none" create-session="never" use-expressions="true"/>
   <http pattern="/viewExpired.xhtml" security="none" create-session="never" use-expressions="true"/>
   <http pattern="/404.xhtml" security="none" create-session="never" use-expressions="true"/>

   <!-- Signup/Password Setup  -->
   <http pattern="/signup.xhtml" security="none" create-session="never" use-expressions="true"/>
   <http pattern="/signup2.xhtml" security="none" create-session="never" use-expressions="true"/>
   <http pattern="/signup3.xhtml" security="none" create-session="never" use-expressions="true"/>
   <http pattern="/forgot.xhtml" security="none" create-session="never" use-expressions="true"/>
   <http pattern="/activate.xhtml" security="none" create-session="never" use-expressions="true"/>
   <http pattern="/reset.xhtml" security="none" create-session="never" use-expressions="true"/>
   <http pattern="/approved.xhtml" security="none" create-session="never" use-expressions="true"/>

   <!-- Base Directories for Project to exclude from Security  -->
   <http pattern="/css/**" security="none"/>
   <http pattern="/js/**" security="none"/>
   <http pattern="/javax.faces.resource/*" security="none"/>
   <http pattern="/javax.faces.resource/**" security="none"/>
   <http pattern="/images/**" security="none"/>
   <http pattern="/pages/try/**" security="none"/>
   <http pattern="/template/**" security="none"/>
   <http pattern="/static/**" security="none"/>
   <http pattern="/pages/static/**" security="none"/>
   <http pattern="/spark/**" security="none"/>
   <http pattern="/reports/**" security="none"/>
   <http pattern="/spark/ui/**" security="none"/>
   <http pattern="/modena/ui/**" security="none"/>

   <http auto-config="true" access-denied-page="/access-denied.xhtml">
      <custom-filter ref="sessionManagementFilter" before="SESSION_MANAGEMENT_FILTER" />
      <form-login login-page="/login.xhtml" default-target-url="${ssl.url}/loginRedirection.xhtml"
                  always-use-default-target="true"/>

      <!--  Active pages -->
      <intercept-url pattern="/loginRedirection.xhtml" access="IS_AUTHENTICATED_ANONYMOUSLY"/>
      <intercept-url pattern="/createInvestment.xhtml" access="IS_AUTHENTICATED_ANONYMOUSLY"/>
      <intercept-url pattern="/manage.xhtml" access="IS_AUTHENTICATED_ANONYMOUSLY"/>
      <intercept-url pattern="/managegoals.xhtml" access="IS_AUTHENTICATED_ANONYMOUSLY"/>
      <intercept-url pattern="/manageallocation.xhtml" access="IS_AUTHENTICATED_ANONYMOUSLY"/>
      <intercept-url pattern="/managePortfolio.xhtml" access="IS_AUTHENTICATED_ANONYMOUSLY"/>
      <intercept-url pattern="/debtandliabilities.xhtml" access="IS_AUTHENTICATED_ANONYMOUSLY"/>
      <intercept-url pattern="/risktolerance.xhtml" access="IS_AUTHENTICATED_ANONYMOUSLY"/>
      <intercept-url pattern="/position.xhtml" access="IS_AUTHENTICATED_ANONYMOUSLY"/>

      <!--  Test Pages - Disabled  -->

      <!--  Original  pages  -->
      <intercept-url pattern="/admin/**" access="IS_AUTHENTICATED_ANONYMOUSLY"/>
   <!--  Advisor pages  -->
      <intercept-url pattern="/advisor/**" access="IS_AUTHENTICATED_ANONYMOUSLY"/>


      <!--  Admin pages  -->
      <intercept-url pattern="/pages/admin/**" access="IS_AUTHENTICATED_ANONYMOUSLY"/>
      <!--  Advisor/Consumer pages  -->
      <intercept-url pattern="/pages/advisor/**" access="IS_AUTHENTICATED_ANONYMOUSLY"/>
      <intercept-url pattern="/pages/consumer/**" access="IS_AUTHENTICATED_ANONYMOUSLY"/>
      <intercept-url pattern="/pages/common/**" access="IS_AUTHENTICATED_ANONYMOUSLY"/>


      <logout logout-success-url="${apache.url}"/>

      <intercept-url pattern="/**" access="ROLE_USER"/>
      <session-management invalid-session-url="${ssl.url}/pages/common/view-expired.xhtml"/>
      <remember-me key="${ssl.url}"/>
   </http>


    <authentication-manager>
        <authentication-provider user-service-ref="userDetailsService">
            <password-encoder hash="md5"/>
        </authentication-provider>
    </authentication-manager>

    <beans:bean id="userDetailsService" class="com.invessence.dao.common.CustomJdbcDaoImpl">
        <beans:property name="dataSource" ref="dataSource"/>
        <beans:property name="emailMessage" ref="emailMessage"/>
        <beans:property name="uiLayout" ref="uiLayout"/>

        <beans:property name="usersByUsernameQuery"
                        value="select logonid, userid, email, pwd, logonstatus, firstname, lastname, ip, resetID, cid, advisor, rep, emailmsgtype, access from user_logon where userid=?"/>
        <beans:property name="listofQAQuery"
                        value="select question1, answer1, question2, answer2, question3, answer3 from user_logon where userid=?"/>
        <beans:property name="authoritiesByUsernameQuery"
                        value="select r.role from user_logon ul, role r where ul.logonid=r.logonid and ul.userid =?"/>
        <beans:property name="lockUserSql"
                        value="update user_logon set logonstatus = ?, resetID = ? where userid=?"/>
    </beans:bean>

    <beans:bean id="sessionManagementFilter" class="org.springframework.security.web.session.SessionManagementFilter">
        <beans:constructor-arg name="securityContextRepository" ref="httpSessionSecurityContextRepository" />
        <beans:property name="invalidSessionStrategy" ref="monitorSession" />
    </beans:bean>

    <beans:bean id="monitorSession" class="com.invessence.util.MonitorSession">
        <beans:property name="invalidSessionUrl" value="/view-expired.xhtml" />
    </beans:bean>

    <beans:bean id="httpSessionSecurityContextRepository" class="org.springframework.security.web.context.HttpSessionSecurityContextRepository"/>

</beans:beans>