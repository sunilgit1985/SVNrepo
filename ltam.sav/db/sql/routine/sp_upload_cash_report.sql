DROP PROCEDURE IF EXISTS `sp_upload_cash_report`;

DELIMITER $$
CREATE PROCEDURE `sp_upload_cash_report`()
BEGIN 
   begin
		delete from cash_report
		where concat(`clientAccountID`,`fromDate`,`toDate`) in (select concat(`clientAccountID`,replace(`fromDate`,'-',''),replace(`toDate`,'-',''))
																  from tmp_cash_report)
		;
   end;

   begin
			INSERT INTO `cash_report`
			(`clientAccountID`,
			`accountAlias`,
			`currencyPrimary`,
			`fromDate`,
			`toDate`,
			`startingCash`,
			`startingCashSecurities`,
			`startingCashCommodities`,
			`commissions`,
			`commissionsSecurities`,
			`commissionsCommodities`,
			`commissionsMTD`,
			`commissionsYTD`,
			`deposit_Withdrawals`,
			`deposit_WithdrawalsSecurities`,
			`deposit_WithdrawalsCommodities`,
			`deposit_WithdrawalsMTD`,
			`deposit_WithdrawalsYTD`,
			`deposits`,
			`depositsSecurities`,
			`depositsCommodities`,
			`depositsMTD`,
			`depositsYTD`,
			`withdrawals`,
			`withdrawalsSecurities`,
			`withdrawalsCommodities`,
			`withdrawalsMTD`,
			`withdrawalsYTD`,
			`accountTransfers`,
			`accountTransfersSecurities`,
			`accountTransfersCommodities`,
			`accountTransfersMTD`,
			`accountTransfersYTD`,
			`internalTransfers`,
			`internalTransfersSecurities`,
			`internalTransfersCommodities`,
			`internalTransfersMTD`,
			`internalTransfersYTD`,
			`dividends`,
			`dividendsSecurities`,
			`dividendsCommodities`,
			`dividendsMTD`,
			`dividendsYTD`,
			`brokerInterest`,
			`brokerInterestSecurities`,
			`brokerInterestCommodities`,
			`brokerInterestMTD`,
			`brokerInterestYTD`,
			`bondInterest`,
			`bondInterestSecurities`,
			`bondInterestCommodities`,
			`bondInterestMTD`,
			`bondInterestYTD`,
			`cashSettlingMtm`,
			`cashSettlingMtmSecurities`,
			`cashSettlingMtmCommodities`,
			`cashSettlingMtmMTD`,
			`cashSettlingMtmYTD`,
			`netTradesSales`,
			`netTradesSalesSecurities`,
			`netTradesSalesCommodities`,
			`netTradesSalesMTD`,
			`netTradesSalesYTD`,
			`netTradesPurchases`,
			`netTradesPurchasesSecurities`,
			`netTradesPurchasesCommodities`,
			`netTradesPurchasesMTD`,
			`netTradesPurchasesYTD`,
			`advisorFees`,
			`advisorFeesSecurities`,
			`advisorFeesCommodities`,
			`advisorFeesMTD`,
			`advisorFeesYTD`,
			`otherFees`,
			`otherFeesSecurities`,
			`otherFeesCommodities`,
			`otherFeesMTD`,
			`otherFeesYTD`,
			`paymentInLieu`,
			`paymentInLieuSecurities`,
			`paymentInLieuCommodities`,
			`paymentInLieuMTD`,
			`paymentInLieuYTD`,
			`transactionTax`,
			`transactionTaxSecurities`,
			`transactionTaxCommodities`,
			`transactionTaxMTD`,
			`transactionTaxYTD`,
			`withholdingTax`,
			`withholdingTaxSecurities`,
			`withholdingTaxCommodities`,
			`withholdingTaxMTD`,
			`withholdingTaxYTD`,
			`salesTax`,
			`salesTaxSecurities`,
			`salesTaxCommodities`,
			`salesTaxMTD`,
			`salesTaxYTD`,
			`fXTranslationGain_Loss`,
			`fXTranslationGain_LossSecurities`,
			`fXTranslationGain_LossCommodities`,
			`endingCash`,
			`endingCashSecurities`,
			`endingCashCommodities`,
			`endingSettledCash`,
			`endingSettledCashSecurities`,
			`endingSettledCashCommodities`)
			SELECT `tmp_cash_report`.`clientAccountID`,
				`tmp_cash_report`.`accountAlias`,
				`tmp_cash_report`.`currencyPrimary`,
				replace(`tmp_cash_report`.`fromDate`,'-',''),
				replace(`tmp_cash_report`.`toDate`,'-',''),
				`tmp_cash_report`.`startingCash`,
				`tmp_cash_report`.`startingCashSecurities`,
				`tmp_cash_report`.`startingCashCommodities`,
				`tmp_cash_report`.`commissions`,
				`tmp_cash_report`.`commissionsSecurities`,
				`tmp_cash_report`.`commissionsCommodities`,
				`tmp_cash_report`.`commissionsMTD`,
				`tmp_cash_report`.`commissionsYTD`,
				`tmp_cash_report`.`deposit_Withdrawals`,
				`tmp_cash_report`.`deposit_WithdrawalsSecurities`,
				`tmp_cash_report`.`deposit_WithdrawalsCommodities`,
				`tmp_cash_report`.`deposit_WithdrawalsMTD`,
				`tmp_cash_report`.`deposit_WithdrawalsYTD`,
				`tmp_cash_report`.`deposits`,
				`tmp_cash_report`.`depositsSecurities`,
				`tmp_cash_report`.`depositsCommodities`,
				`tmp_cash_report`.`depositsMTD`,
				`tmp_cash_report`.`depositsYTD`,
				`tmp_cash_report`.`withdrawals`,
				`tmp_cash_report`.`withdrawalsSecurities`,
				`tmp_cash_report`.`withdrawalsCommodities`,
				`tmp_cash_report`.`withdrawalsMTD`,
				`tmp_cash_report`.`withdrawalsYTD`,
				`tmp_cash_report`.`accountTransfers`,
				`tmp_cash_report`.`accountTransfersSecurities`,
				`tmp_cash_report`.`accountTransfersCommodities`,
				`tmp_cash_report`.`accountTransfersMTD`,
				`tmp_cash_report`.`accountTransfersYTD`,
				`tmp_cash_report`.`internalTransfers`,
				`tmp_cash_report`.`internalTransfersSecurities`,
				`tmp_cash_report`.`internalTransfersCommodities`,
				`tmp_cash_report`.`internalTransfersMTD`,
				`tmp_cash_report`.`internalTransfersYTD`,
				`tmp_cash_report`.`dividends`,
				`tmp_cash_report`.`dividendsSecurities`,
				`tmp_cash_report`.`dividendsCommodities`,
				`tmp_cash_report`.`dividendsMTD`,
				`tmp_cash_report`.`dividendsYTD`,
				`tmp_cash_report`.`brokerInterest`,
				`tmp_cash_report`.`brokerInterestSecurities`,
				`tmp_cash_report`.`brokerInterestCommodities`,
				`tmp_cash_report`.`brokerInterestMTD`,
				`tmp_cash_report`.`brokerInterestYTD`,
				`tmp_cash_report`.`bondInterest`,
				`tmp_cash_report`.`bondInterestSecurities`,
				`tmp_cash_report`.`bondInterestCommodities`,
				`tmp_cash_report`.`bondInterestMTD`,
				`tmp_cash_report`.`bondInterestYTD`,
				`tmp_cash_report`.`cashSettlingMtm`,
				`tmp_cash_report`.`cashSettlingMtmSecurities`,
				`tmp_cash_report`.`cashSettlingMtmCommodities`,
				`tmp_cash_report`.`cashSettlingMtmMTD`,
				`tmp_cash_report`.`cashSettlingMtmYTD`,
				`tmp_cash_report`.`netTradesSales`,
				`tmp_cash_report`.`netTradesSalesSecurities`,
				`tmp_cash_report`.`netTradesSalesCommodities`,
				`tmp_cash_report`.`netTradesSalesMTD`,
				`tmp_cash_report`.`netTradesSalesYTD`,
				`tmp_cash_report`.`netTradesPurchases`,
				`tmp_cash_report`.`netTradesPurchasesSecurities`,
				`tmp_cash_report`.`netTradesPurchasesCommodities`,
				`tmp_cash_report`.`netTradesPurchasesMTD`,
				`tmp_cash_report`.`netTradesPurchasesYTD`,
				`tmp_cash_report`.`advisorFees`,
				`tmp_cash_report`.`advisorFeesSecurities`,
				`tmp_cash_report`.`advisorFeesCommodities`,
				`tmp_cash_report`.`advisorFeesMTD`,
				`tmp_cash_report`.`advisorFeesYTD`,
				`tmp_cash_report`.`otherFees`,
				`tmp_cash_report`.`otherFeesSecurities`,
				`tmp_cash_report`.`otherFeesCommodities`,
				`tmp_cash_report`.`otherFeesMTD`,
				`tmp_cash_report`.`otherFeesYTD`,
				`tmp_cash_report`.`paymentInLieu`,
				`tmp_cash_report`.`paymentInLieuSecurities`,
				`tmp_cash_report`.`paymentInLieuCommodities`,
				`tmp_cash_report`.`paymentInLieuMTD`,
				`tmp_cash_report`.`paymentInLieuYTD`,
				`tmp_cash_report`.`transactionTax`,
				`tmp_cash_report`.`transactionTaxSecurities`,
				`tmp_cash_report`.`transactionTaxCommodities`,
				`tmp_cash_report`.`transactionTaxMTD`,
				`tmp_cash_report`.`transactionTaxYTD`,
				`tmp_cash_report`.`withholdingTax`,
				`tmp_cash_report`.`withholdingTaxSecurities`,
				`tmp_cash_report`.`withholdingTaxCommodities`,
				`tmp_cash_report`.`withholdingTaxMTD`,
				`tmp_cash_report`.`withholdingTaxYTD`,
				`tmp_cash_report`.`salesTax`,
				`tmp_cash_report`.`salesTaxSecurities`,
				`tmp_cash_report`.`salesTaxCommodities`,
				`tmp_cash_report`.`salesTaxMTD`,
				`tmp_cash_report`.`salesTaxYTD`,
				`tmp_cash_report`.`fXTranslationGain_Loss`,
				`tmp_cash_report`.`fXTranslationGain_LossSecurities`,
				`tmp_cash_report`.`fXTranslationGain_LossCommodities`,
				`tmp_cash_report`.`endingCash`,
				`tmp_cash_report`.`endingCashSecurities`,
				`tmp_cash_report`.`endingCashCommodities`,
				`tmp_cash_report`.`endingSettledCash`,
				`tmp_cash_report`.`endingSettledCashSecurities`,
				`tmp_cash_report`.`endingSettledCashCommodities`
			FROM `tmp_cash_report`;
   end;

	begin
		DELETE FROM `position`
		where concat(`clientAccountID`,`symbol`,`reportDate`) in 
				(select concat(`clientAccountID`,'Cash',replace(`toDate`,'-',''))
				 from tmp_cash_report)
		;
	end;

	begin
				INSERT INTO `position`
					(`clientAccountID`,
					`accountAlias`,
					`currencyPrimary`,
					`assetClass`,
					`fxRateToBase`,
					`symbol`,
					`description`,
					`reportDate`,
					`side`,
					`quantity`,
					`costBasisPrice`,
					`CostBasisMoney`,
					`markPrice`,
					`positionValue`,
					`fifoPnlUnrealized`,
					`LevelOfDetail`)
				SELECT 
					`tmp`.`clientAccountID`,
					`tmp`.`accountAlias`,
					`tmp`.`currencyPrimary`,
					'Cash',
					1,
					'Cash',
					'Money Market',				
					replace(`tmp`.`toDate`,'-',''),
					CASE 
					  WHEN (`tmp`.`endingCash` < 0) THEN 'Short'
					  ELSE 'Long'
					END,
					round(`tmp`.`endingCash`,0),
					1,
					`tmp`.`endingCash`,
					1,
					`tmp`.`endingCash`,
					0,
					'SUMMARY'
				FROM `tmp_cash_report` as `tmp`;
	end;

END

$$
DELIMITER ;
